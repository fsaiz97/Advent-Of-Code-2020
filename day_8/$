from dataclasses import dataclass


@dataclass
class Instruction:
    operation: str
    argument: int

    def get():
        return (operation, argument)


class Computer:
    def __init__(self):
        self.accumulator = 0
        self.program_counter = 0
        self.program = []
        self.instruction_register = None
        self.halt = False


    def print_state(self):
        print(f"{self.program_counter = }\n{self.accumulator = }")
 

    def load_program(self, program):
        self.program = program
        print("Program loaded.")


    def fetch(self):
        try:
            if self.halt == False:
                self.instruction_register = self.program[self.program_counter]
        except IndexError:
            self.instruction_register = Instruction(hlt, -1)


    def execute(self):
        try:
            opcode, argument = self.instruction_register.get()

            if opcode == 'acc':
                self.accumulator += argument
                self.program_counter += 1
            elif opcode == 'jmp':
                self.program_counter += argument
            elif opcode == 'nop':
                self.program_counter += 1
            elif opcode == 'hlt':
                self.halt = True
                print("Program halted.")
            else:
                raise ValueError
        except ValueError:
            print("Invalid opcode")
            raise


    def run_program(self, step = False):
        while self.halt == False:
            self.fetch()
            self.execute()
            if step == True:
                self.print_state()
                print("\n")

        self.print_state()


def parse_input():
    with open('test.txt') as file:
        program = [Instruction(operation, argument) for operation, argument in (line.strip().split(' ') for line in file)]
        #print(f"{program = }")  # debug
        return program


def main():
    computer = Computer()

    program = parse_input()
    computer.load_program(program)
    repetitions = set()

    while True:
        computer.run_program(step = True)
        
        if computer.halt == True:
            break
        if computer.program_counter in repetitions:
            print("Final accumulator value =", computer.accumulator)
            break
        else:
            repetitions.add(computer.program_counter)



if __name__ == '__main__':
    main()
